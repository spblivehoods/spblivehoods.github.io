<!DOCTYPE html>
<html>
<head>
	<title>
		Livehoods-SPB
	</title>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

   <!-- Make sure you put this AFTER Leaflet's CSS -->
 	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>

   <link rel="stylesheet" type="text/css" href="main.css">
   <script src="https://d3js.org/d3.v4.min.js"></script>

   <script type="text/javascript" src='data/venues.geojson'></script>
   <script type="text/javascript" src='data/areas.geojson'></script>
   <script type="text/javascript" src='data/metro_stations.geojson'></script>

</head>
<body>
	 <div id="mapid" style="height: 97.7vh; width: 97.5vw; z-index: 0">
	 	
	 </div>

	 <div class="info">
	 	<p> Click to area </p>
	 	<div class="functions"></div>
	 </div>

	 <script type="text/javascript">

	 	var map = L.map('mapid').setView([59.9451, 30.3717], 13);

	 	L.tileLayer('https://api.mapbox.com/styles/v1/konuchovartem/cjjtpqh8r3kuy2rqnmlagk19f/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoia29udWNob3ZhcnRlbSIsImEiOiJjajhoOGJmZmQwMDltMndrbnhnY3J5andvIn0.9iiSiT1X3i5zSU4YTr9c9w',
		    maxZoom: 18,
		}).addTo(map);

		//get color
		function getColor(id){

			switch(id) {
    			case 0: return "#1fd9d3";
				case 1: return "#ee6b7b";
				case 2: return "#4d01ff";
				case 3: return "#e3c331";
				case 4: return  "#e5218d";
				case 5: return "#a4dc6f";
				case 6: return "#b5c849";
				case 7: return "#ea33d8";
				case 8: return "#2f3dd7";
				case 9: return "#91ed66";
				case 10: return "#6f65d9";
				case 11: return "#6f65d9";
				case 12: return "#ce3462";
				case 13: return "#c95e76";
				case 14: return  "#4527dd";
				case 15: return  "#8316f0";
				case 16: return  "#3bec5e";
				case 17: return  "#69eb78";
				case 18: return  "#c48aea";
				case 19: return  "#e07ec4";
				case 20: return  "#17acf0";
				case 21: return  "#39ca0d";
				case 22: return  "#39ca0d";
				case 23: return  "#fd9000";
				case 24: return  "#51e0b8";
				case 25: return  "#ec1d1d";
				case 26: return  "#85cf23";
				case 27: return  "#cebc18";
				case 28: return  "#ccb36f";
				case 29: return  "#ccb36f";
				case 30: return  "#82e085";
				case 31: return  "#eec083";
				case 32: return  "#4fdaca";
				case 33: return  "#ed9157";
				case 34: return  "#194fe1";
				case 35: return  "#a848d5";
				case 36: return  "#7cd477";
				case 37: return  "#d33ced";
				case 38: return  "#96e00d";
				case 39: return  "#a848d5";
				case 40: return  "#ca4276";
				case 41: return  "#d27952";
				case 42: return  "#75d4f0";
				case 43: return  "#7989d1";
				case 44: return  "#58d0e2";
				case 45: return  "#58d0e2";
				case 46: return  "#01eeff";
				case 47: return  "#f3ff01";
				case 48: return  "#d29524";
				case 49: return  "#e134a2";
				case 50: return  "#e52d24";
				case 51: return  "#5eccd2";
				case 52: return  "#42ed72";
				case 53: return  "#e8b283";
				case 54: return  "#7e5ce6";
				case 55: return  "#60b4eb";
				case 56: return  "#e55b9b";
				case 57: return  "#d65fde";
				case 58: return  "#9fcd21";
				case 59: return  "#f0f313";
				case 60: return  "#08ed2a";
				case 61: return  "#f13e12";
				case 62: return  "#e44046";
				case 63: return  "#3bcb97";
				case 64: return  "#3bcb97";
				case 65: return  "#e4e26a";
				case 66: return  "#c54de9";
				case 67: return  "#ff0178";
				case 68: return  "#80a4d3";
				case 69: return  "#89f0b7";
    		};
		}

		/*
		//show venues	 
	 	var geojsonMarkerOptions = {
			    radius: 3,
			    color: "#000",
			    weight: 1,
			    opacity: 1,
			    fillOpacity: 0.8
			};

		function onEachVenueFeature(feature, layer) {
			var popupContent = ""

			if (feature.properties && feature.properties.title) {
				popupContent += feature.properties.title;
			}

			layer.bindPopup(popupContent);
		}

		L.geoJSON(venues, {
			onEachFeature: onEachVenueFeature,

			pointToLayer: function (feature, latlng) {
        		return L.circleMarker(latlng, geojsonMarkerOptions);
    		},

    		style: function(feature) {
    			var style = {};
    			style["fillColor"] = getColor(feature.properties.label);
    			return style;
    		}

		}).addTo(map);
		*/


		//show areas

		var selectedArea = null;

		function dropHiglite(){
			areas.setStyle({
				opacity: 0,
				fillOpacity: 0
			})
		}


		function zoomToFeature(e) {
		    map.fitBounds(e.target.getBounds());
		}	

		function highliteArea(e){

			var layer = e.target;

			layer.setStyle({
				opacity: 1,
				fillOpacity: 0.3
			})
		   
		}

		function resetHighlight(e) {
			var layer = e.target;
			if (layer != selectedArea){
		    	areas.resetStyle(layer);
		    }
		}

		function selectArea(e){

			var layer = e.target;
			
			dropHiglite();

			highliteArea(e);

			updateInfo(e.target.feature.properties);
			//info.update(e.target.feature.properties);

			selectedArea = e.target;
		}



		function onEachAreaFeature(feature, layer){

			layer.on({
				mouseover: highliteArea,
        		mouseout: resetHighlight,
				click: selectArea
			})

		};

		var areas = L.geoJSON(areas, {
			onEachFeature: onEachAreaFeature,

			style: function(feature) {

				var style = {opacity: 0, fillOpacity: 0};

				var color =  getColor(feature.properties.value);

    			style["color"] = color;

    			return style;
    		},

    		

		}).addTo(map);

		//show metro
		var metroIcon = L.icon({
			iconUrl: 'img/metro_icon.svg',

			iconSize:     [25, 25], // size of the icon
		    //shadowSize:   [50, 64], // size of the shadow
		    //iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
		    //shadowAnchor: [4, 62],  // the same for the shadow
		    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
		})


		L.geoJSON(metro_stations, {

			pointToLayer: function (feature, latlng) {
        		return L.marker(latlng, {icon: metroIcon});
    		}

		}).addTo(map);


		//info control

		var x = d3.scaleLinear()
 			.range([0, 200]);


 		function getAreaId(props){
 			var id

 			if(props){
 				id = props.value.toString();
 			}

 			return id;
 		}

 		function getFuncData(props){
 			var data = {};

 			if(props){
 				data["Arts & Entertainment"] = props["Arts & Entertainment"];
 				data["College & University"] = props["College & University"];
 				data["Food"] = props["Food"];
 				data["Nightlife Spot"] = props["Nightlife Spot"];
 				data["Outdoors & Recreation"] = props["Outdoors & Recreation"];
 				data["Professional & Other Places"] = props["Professional & Other Places"];
 				data["Residence"] = props["Residence"];
 				data["Shop & Service"] = props["Shop & Service"];
 				data["Travel & Transport"] = props["Travel & Transport"];
 			}

 			return data;
 		}


 		function getAreaData(props){
 			
 			var func = getFuncData(props);

 			var data = [];

 			if (func) {
 				Object.keys(func).forEach(function(key,index){
 					newObj = {"name": key, "number": func[key]};
 					data.push(newObj);
 				})
 			}

 			return data;
 		}
 		
 		function getBarText(d,t){
 			return t.toString() + " " + d.toString();
 		}

		function updateInfo(props){

			if (props){
			
				var id  = getAreaId(props);
				var data = getAreaData(props);
				var func = getFuncData(props);

				x.domain([0,d3.sum(Object.values(func))]);

				if (!selectedArea){

					d3.select('.info p')
						.text("Area №" + id);

					d3.select('.functions')
						.selectAll('div')
							.data(data)
						.enter().append('div')
						.style("width", function(d) { return x(d.number) + "px"; })
			    		.text(function(d){return d.number + " (" + d.number.toString()} + ")");
				};

				area_id = d3.select('.info p').text("Area №" + id);

				var bars = d3.select('.functions').selectAll('div').data(data);

				bars.exit().remove();

				bars.enter().append('div');
						
			    bars.transition()
			    	.duration(500)
			    	.style("width", function(d) { return x(d.number) + "px"; })
			    	.text(function(d) { return d.name + " (" + d.number.toString() + ")"});
		    }
		}; 

	 </script>

</body>
</html>